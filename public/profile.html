<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Trading App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            padding-bottom: 80px; 
            background-color: #0c1021; 
        }

        .bottom-nav { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            width: 100%; 
            display: flex; 
            justify-content: space-around; 
            z-index: 1000; 
            background-color: #111827; 
            border-top: 1px solid #374151; 
            padding: 8px 0; 
        }
        .nav-link { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            flex-grow: 1; 
            text-decoration: none; 
            color: #9ca3af; 
            font-weight: 500; 
            font-size: 0.75rem;
            transition: all 0.2s ease-in-out; 
            gap: 4px; 
            width: 20%; 
        }
        .nav-link svg { 
            width: 24px; 
            height: 24px; 
        }
        .nav-link.active { 
            color: #4ade80; 
            font-weight: 600; 
        }

        .text-success { color: rgb(34, 197, 94); }
        .text-warning { color: rgb(245, 158, 11); }
        .text-danger { color: rgb(239, 68, 68); }

        #avatar { 
            background-color: #4b5563;
        }
    </style>
</head>
<body class="text-gray-100">

    <script>
        const token = localStorage.getItem('authToken');
        if (!token) { window.location.href = '/login.html'; }
    </script>

    <div class="container mx-auto p-4 max-w-4xl">

        <header class="p-4 border-b border-gray-700 mb-6 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <div id="avatar" class="w-16 h-16 rounded-full flex items-center justify-center text-2xl font-bold text-white flex-shrink-0"></div>
                <div>
                    <h1 class="text-2xl font-bold text-white">Welcome, <span id="username-display" class="text-xl">...</span></h1>
                    <p class="text-sm text-gray-400">Joined: <span id="joined-date-display">...</span></p>
                </div>
            </div>
            <div class="text-right">
                <p class="text-lg font-semibold">Balance: <span id="balance-display" class="text-green-400">$0.00</span></p>
                <button id="logout-button" class="mt-2 px-3 py-1 text-xs font-medium text-white bg-red-600 rounded-lg hover:bg-red-700">Logout</button>
            </div>
        </header>

        <main class="space-y-6">
            <div class="p-4 space-y-4">
                <h2 class="text-xl font-semibold mb-4">Trading Statistics</h2>
                <div id="stats-loading" class="text-center text-gray-400 py-8">Loading stats...</div>
                <div id="stats-content" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-6 items-center mb-6">
                        <div class="md:col-span-2 grid grid-cols-2 gap-4 text-center">
                            <div class="bg-gray-800 p-4 rounded-lg"><p class="text-2xl font-bold text-green-400" id="stats-netpnl">$0.00</p><p class="text-sm text-gray-400">Net P&L</p></div>
                            <div class="bg-gray-800 p-4 rounded-lg"><p class="text-2xl font-bold" id="stats-wins">-</p><p class="text-sm text-gray-400">Wins</p></div>
                            <div class="bg-gray-800 p-4 rounded-lg col-span-2"><p class="text-2xl font-bold" id="stats-losses">-</p><p class="text-sm text-gray-400">Losses</p></div>
                        </div>
                        <div id="win-loss-chart-container" class="md:col-span-3 flex justify-center">
                            <div id="win-loss-chart" style="width: 220px; height: 220px;"></div>
                        </div>
                    </div>
                    <div class="border-t border-gray-700 pt-4 grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
                        <div class="bg-gray-800 p-4 rounded-lg"><p class="text-2xl font-bold" id="stats-total-trades">-</p><p class="text-sm text-gray-400">Total Trades</p></div>
                        <div class="bg-gray-800 p-4 rounded-lg"><p class="text-2xl font-bold" id="stats-volume">$0.00</p><p class="text-sm text-gray-400">Total Volume</p></div>
                        <div class="bg-gray-800 p-4 rounded-lg col-span-2 sm:col-span-2"><p class="text-2xl font-bold" id="stats-avg-size">$0.00</p><p class="text-sm text-gray-400">Avg. Trade Size</p></div>
                    </div>
                </div>
            </div>

            <div class="h-px bg-gray-700 mx-4"></div>

            <div class="p-4 space-y-4">
                <h2 class="text-xl font-semibold mb-2">Trading Volume Requirement</h2>
                <p class="text-xs text-gray-400 mb-4">A 50% tax is applied to withdrawals if your total trade volume is less than 110% of your total deposits.</p>
                <div id="volume-loading" class="text-center text-gray-400 py-4">Loading volume data...</div>
                <div id="volume-content" class="hidden">
                    <div class="flex justify-between mb-1 text-sm font-medium text-gray-300">
                        <span id="volume-traded-text">$0.00</span>
                        <span id="volume-required-text">$0.00</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2.5">
                        <div id="volume-progress-bar" class="bg-green-600 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                    <div class="flex justify-between mt-1 text-xs text-gray-500">
                        <span>Volume Traded</span>
                        <span>Requirement</span>
                    </div>
                </div>
            </div>

            <div class="h-px bg-gray-700 mx-4"></div>

            <div class="p-4 space-y-4">
                 <h2 class="text-xl font-semibold mb-4">Account Actions</h2>
                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                     <button id="show-password-btn" class="w-full text-left p-4 bg-green-600 hover:bg-green-700 rounded-lg font-semibold">Change Password</button>
                     <button id="show-referral-btn" class="w-full text-left p-4 bg-green-600 hover:bg-green-700 rounded-lg font-semibold">View Referral Program</button>
                 </div>
            </div>

            <div id="security-section" class="p-4 space-y-4 hidden">
                <h2 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2">Change Password</h2>
                <form id="change-password-form" class="space-y-4 max-w-md">
                    <div>
                        <label for="current-password" class="block text-sm font-medium text-gray-300">Current Password</label>
                        <input type="password" id="current-password" required class="mt-1 w-full bg-gray-900 border-gray-700 rounded-md p-3 text-white">
                    </div>
                    <div>
                        <label for="new-password" class="block text-sm font-medium text-gray-300">New Password</label>
                        <input type="password" id="new-password" required class="mt-1 w-full bg-gray-900 border-gray-700 rounded-md p-3 text-white">
                    </div>

                    <div>
                        <label for="confirm-new-password" class="block text-sm font-medium text-gray-300">Confirm New Password</label>
                        <input type="password" id="confirm-new-password" required class="mt-1 w-full bg-gray-900 border-gray-700 rounded-md p-3 text-white">
                    </div>
                    <button type="submit" id="password-submit-btn" class="w-full px-4 py-2 font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700">Change Password</button>
                </form>
                <div id="password-message" class="mt-4 text-center text-sm"></div>
            </div>

            <div id="referral-section" class="p-4 space-y-4 hidden">
                <h2 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2">Referral Program</h2>
                <div id="ref-loading" class="text-center text-gray-400 py-8">Loading...</div>
                <div id="ref-content" class="hidden space-y-4">
                    <div>
                        <label class="text-sm font-medium text-gray-300">Your Referral Link</label>
                        <div class="mt-1 flex rounded-md shadow-sm">
                            <input type="text" id="ref-link-input" readonly class="flex-1 w-full rounded-none rounded-l-md bg-gray-900 p-3 text-gray-300 border border-gray-700">
                            <button id="copy-ref-link-btn" class="px-4 rounded-r-md bg-green-600 hover:bg-green-700">Copy</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-center pt-2">
                        <div class="bg-gray-800 p-4 rounded-lg"><p class="text-3xl font-bold" id="ref-count">-</p><p class="text-sm text-gray-400">Referred</p></div>
                        <div class="bg-gray-800 p-4 rounded-lg"><p class="text-3xl font-bold text-green-400" id="ref-commissions">$0.00</p><p class="text-sm text-gray-400">Commissions</p></div>
                    </div>
                </div>
            </div>

            <div class="h-px bg-gray-700 mx-4"></div>

            <div class="p-4 space-y-4">
                <h2 class="text-xl font-semibold mb-4">KYC Verification</h2>

                <p class="mb-3">
                    Current Status: <strong id="kyc-status" class="text-gray-400">Loading...</strong>
                </p>

                <div id="kyc-upload-form-container" class="mt-4" style="display: none;">
                    <form id="kyc-upload-form" class="space-y-4 max-w-lg" enctype="multipart/form-data">
                        <p class="text-sm text-gray-400">Upload the front and back of your Government-issued ID (Max 5MB per file).</p>

                        <div>
                            <label for="id-front" class="block text-sm font-medium text-gray-300 mb-1">1. ID Front Side</label>
                            <input type="file" class="w-full bg-gray-900 border border-gray-700 rounded-md p-2 text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-600 file:text-white hover:file:bg-green-700" id="id-front" name="front" accept="image/*,.pdf" required>
                        </div>

                        <div>
                            <label for="id-back" class="block text-sm font-medium text-gray-300 mb-1">2. ID Back Side</label>
                            <input type="file" class="w-full bg-gray-900 border border-gray-700 rounded-md p-2 text-white file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-600 file:text-white hover:file:bg-green-700" id="id-back" name="back" accept="image/*,.pdf" required>
                        </div>

                        <button type="submit" id="upload-button" class="w-full px-4 py-2 font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700">
                            Upload Documents
                        </button>
                    </form>
                    <div id="kyc-message" class="mt-4 text-center text-sm"></div>
                </div>

                <div id="kyc-review-message" class="mt-4 text-center text-sm text-warning" style="display:none;">
                    Documents uploaded successfully. Your KYC status is now under review.
                </div>
                <div id="kyc-rejected-message" class="mt-4 text-center text-sm text-danger" style="display:none;">
                    <p class="font-semibold">KYC Rejected</p>
                    <p id="rejection-reason-text" class="text-xs italic">Reason: Documents did not meet requirements.</p>
                    <p class="mt-2 text-xs">Please re-upload corrected documents below.</p>
                </div>
            </div>
        </main>
    </div>

    <nav class="bottom-nav">
        <a href="dashboard.html" class="nav-link" id="nav-dashboard">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
            <span>Home</span>
        </a>
        <a href="trade.html" class="nav-link" id="nav-trade">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>
            <span>Trade</span>
        </a>
        <a href="deposit.html" class="nav-link" id="nav-deposit">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
            <span>Deposit</span>
        </a>
        <a href="withdraw.html" class="nav-link" id="nav-withdraw">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H4a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
            <span>Withdraw</span>
        </a>
        <a href="profile.html" class="nav-link" id="nav-profile">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
            <span>Profile</span>
        </a>
    </nav>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const currentPage = 'profile';
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            const activeLink = document.getElementById(`nav-${currentPage}`);
            if (activeLink) activeLink.classList.add('active');

            const token = localStorage.getItem('authToken');
            const headers = { 'Authorization': `Bearer ${token}` };
            const postHeaders = { 
                'Content-Type': 'application/json', 
                'Authorization': `Bearer ${token}` 
            };

            const KYC_API_BASE_URL = "/api/kyc"; 

            const usernameDisplay = document.getElementById('username-display');
            const joinedDateDisplay = document.getElementById('joined-date-display');
            const avatarDiv = document.getElementById('avatar');
            const balanceDisplay = document.getElementById('balance-display');
            const logoutButton = document.getElementById('logout-button');
            const statsLoading = document.getElementById('stats-loading');
            const statsContent = document.getElementById('stats-content');
            const winLossChart = echarts.init(document.getElementById('win-loss-chart'));
            const refLoading = document.getElementById('ref-loading');
            const refContent = document.getElementById('ref-content');
            const copyBtn = document.getElementById('copy-ref-link-btn');
            const refLinkInput = document.getElementById('ref-link-input');
            const passwordForm = document.getElementById('change-password-form');
            const passwordMessage = document.getElementById('password-message');
            const passwordSubmitBtn = document.getElementById('password-submit-btn');
            const showPasswordBtn = document.getElementById('show-password-btn');
            const showReferralBtn = document.getElementById('show-referral-btn');
            const securitySection = document.getElementById('security-section');
            const referralSection = document.getElementById('referral-section');
            const volumeLoading = document.getElementById('volume-loading');
            const volumeContent = document.getElementById('volume-content');
            const volumeTradedText = document.getElementById('volume-traded-text');
            const volumeRequiredText = document.getElementById('volume-required-text');
            const volumeProgressBar = document.getElementById('volume-progress-bar');

            const kycStatusSpan = document.getElementById('kyc-status');
            const kycFormContainer = document.getElementById('kyc-upload-form-container');
            const kycUploadForm = document.getElementById('kyc-upload-form');
            const kycUploadButton = document.getElementById('upload-button');
            const kycMessageElement = document.getElementById('kyc-message');
            const kycReviewMessage = document.getElementById('kyc-review-message');
            const kycRejectedMessage = document.getElementById('kyc-rejected-message');
            const rejectionReasonText = document.getElementById('rejection-reason-text');

            const generateColor = (str) => {
                let hash = 0;
                if (!str) return '#6b7280';
                for (let i = 0; i < str.length; i++) {
                    hash = str.charCodeAt(i) + ((hash << 5) - hash);
                }
                let color = '#';
                for (let i = 0; i < 3; i++) {
                    let value = (hash >> (i * 8)) & 0xFF;
                    color += ('00' + value.toString(16)).substr(-2);
                }
                return color;
            };

            // ==========================================
            // KYC FUNCTIONS - FIXED VERSION
            // ==========================================

            async function fetchKycStatus() {
                if (!token) {
                    kycStatusSpan.textContent = "Please log in to check status.";
                    return;
                }

                try {
                    kycStatusSpan.textContent = "Loading...";

                    const response = await fetch(`${KYC_API_BASE_URL}/status`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const data = await response.json();

                    if (data.success) {
                        const status = (data.kycStatus || 'pending').toLowerCase();
                        kycStatusSpan.textContent = status.toUpperCase();

                        kycStatusSpan.classList.remove('text-success', 'text-warning', 'text-danger', 'text-gray-400');
                        kycFormContainer.style.display = 'none';
                        kycReviewMessage.style.display = 'none';
                        kycRejectedMessage.style.display = 'none';
                        kycMessageElement.textContent = '';

                        if (status === 'pending') {
                            kycStatusSpan.classList.add('text-warning');
                            kycFormContainer.style.display = 'block';
                        } else if (status === 'rejected') {
                            kycStatusSpan.classList.add('text-danger');
                            kycFormContainer.style.display = 'block';
                            kycRejectedMessage.style.display = 'block';
                            rejectionReasonText.textContent = `Reason: ${data.rejectionReason || 'Documents did not meet requirements.'}`;
                        } else if (status === 'review' || status === 'under_review') { // <--- THIS LINE IS THE FIX
                            kycStatusSpan.classList.add('text-warning');
                            kycReviewMessage.style.display = 'block';
                        } else if (status === 'verified') {
                            kycStatusSpan.classList.add('text-success');
                        } else {
                            kycStatusSpan.classList.add('text-gray-400');
                            kycFormContainer.style.display = 'block';
                        }
                    } else {
                        throw new Error(data.message || 'Failed to fetch KYC status');
                    }

                } catch (error) {
                    console.error("Error fetching KYC status:", error);
                    kycStatusSpan.textContent = "Service connection failed";
                    kycStatusSpan.classList.add('text-danger');
                    kycFormContainer.style.display = 'block';
                }
            }

            async function handleKycUpload(event) {
                event.preventDefault();

                const form = event.target;
                const formData = new FormData(form);

                kycMessageElement.textContent = "Uploading documents...";
                kycMessageElement.style.color = 'rgb(59, 130, 246)';
                kycUploadButton.disabled = true;
                kycUploadButton.textContent = 'Uploading...';

                try {
                    const frontFileInput = document.getElementById('id-front');
                    const backFileInput = document.getElementById('id-back');
                    
                    const frontFile = frontFileInput.files[0];
                    const backFile = backFileInput.files[0];

                    if (!frontFile || !backFile) {
                        throw new Error("Please select both front and back files.");
                    }

                    const maxSize = 5 * 1024 * 1024;
                    if (frontFile.size > maxSize || backFile.size > maxSize) {
                        throw new Error("Each file must be less than 5MB.");
                    }

                    const response = await fetch(`${KYC_API_BASE_URL}/upload`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    });

                    const data = await response.json();

                    if (data.success) {
                        kycMessageElement.textContent = data.message || 'Upload successful!';
                        kycMessageElement.style.color = 'rgb(34, 197, 94)';

                        form.reset();
                        await fetchKycStatus();
                        kycUploadButton.textContent = 'Upload Documents';

                    } else {
                        throw new Error(data.message || 'Upload failed');
                    }

                } catch (error) {
                    console.error("KYC Upload error:", error);
                    kycMessageElement.textContent = error.message;
                    kycMessageElement.style.color = 'rgb(239, 68, 68)';
                    kycUploadButton.textContent = 'Upload Documents';
                } finally {
                    kycUploadButton.disabled = false;
                }
            }

            // ==========================================
            // INITIALIZATION
            // ==========================================

            fetchKycStatus();
            if (kycUploadForm) {
                kycUploadForm.addEventListener('submit', handleKycUpload);
            }

            fetch('/api/user/info', { headers })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const username = data.user.username;
                        usernameDisplay.textContent = username;
                        joinedDateDisplay.textContent = new Date(data.user.createdAt).toLocaleDateString();
                        avatarDiv.textContent = username.charAt(0).toUpperCase();
                        avatarDiv.style.backgroundColor = generateColor(username);
                        balanceDisplay.textContent = `$${data.user.balance.toFixed(2)}`;
                    }
                });

            fetch('/api/user/stats', { headers })
                .then(res => res.json())
                .then(data => {
                    statsLoading.style.display = 'none';
                    statsContent.classList.remove('hidden');
                    document.getElementById('stats-netpnl').textContent = `$${data.netPnl}`;
                    document.getElementById('stats-wins').textContent = data.wins;
                    document.getElementById('stats-losses').textContent = data.losses;
                    document.getElementById('stats-total-trades').textContent = data.totalTrades;
                    document.getElementById('stats-volume').textContent = `$${data.volume}`;
                    document.getElementById('stats-avg-size').textContent = `$${data.averageTradeSize}`;

                    winLossChart.setOption({
                        backgroundColor: 'transparent',
                        tooltip: { trigger: 'item', formatter: '{b}: {c} ({d}%)' },
                        legend: { show: false },
                        title: {
                            text: `${data.winRate}%`,
                            subtext: 'Win Rate',
                            left: 'center',
                            top: 'center',
                            textStyle: { fontSize: 28, fontWeight: 'bold', color: '#E2E8F0' },
                            subtextStyle: { fontSize: 14, color: '#9CA3AF' }
                        },
                        series: [{
                            name: 'Trade Results', type: 'pie', radius: ['75%', '100%'], avoidLabelOverlap: false, label: { show: false },
                            data: [
                                { value: data.wins, name: 'Wins', itemStyle: { color: '#22c55e' } },
                                { value: data.losses, name: 'Losses', itemStyle: { color: '#ef4444' } },
                                { value: data.ties, name: 'Ties', itemStyle: { color: '#6b7280' } }
                            ]
                        }]
                    });
                });

            fetch('/api/user/volume-data', { headers })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const { totalDeposits, totalTradeVolume } = data;
                        const volumeRequirement = totalDeposits * 1.10;
                        let progressPercent = volumeRequirement > 0 ? (totalTradeVolume / volumeRequirement) * 100 : 100;
                        if (progressPercent > 100) progressPercent = 100;

                        const formatCurrency = (num) => (num || 0).toLocaleString('en-US', { style: 'currency', currency: 'USD' });

                        volumeTradedText.textContent = formatCurrency(totalTradeVolume);
                        volumeRequiredText.textContent = formatCurrency(volumeRequirement);
                        volumeProgressBar.style.width = `${progressPercent}%`;

                        volumeLoading.style.display = 'none';
                        volumeContent.classList.remove('hidden');
                    }
                })
                .catch(error => {
                    console.error('Error fetching volume data:', error);
                    volumeLoading.textContent = 'Could not load data.';
                });

            fetch('/api/user/referral-info', { headers })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        refLoading.style.display = 'none';
                        refContent.classList.remove('hidden');
                        const referralLink = `${window.location.origin}/signup.html?ref=${data.referralCode}`;
                        refLinkInput.value = referralLink;
                        document.getElementById('ref-count').textContent = data.referralCount;
                        document.getElementById('ref-commissions').textContent = `$${data.totalCommissions.toFixed(2)}`;
                    }
                });

            copyBtn.addEventListener('click', () => {
                refLinkInput.select();
                document.execCommand('copy');
                copyBtn.textContent = 'Copied!';
                setTimeout(() => { copyBtn.textContent = 'Copy'; }, 2000);
            });

            passwordForm.addEventListener('submit', (e) => {
                e.preventDefault();
                passwordSubmitBtn.disabled = true;
                passwordSubmitBtn.textContent = 'Updating...';
                passwordMessage.textContent = '';

                const currentPassword = document.getElementById('current-password').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmNewPassword = document.getElementById('confirm-new-password').value;

                fetch('/api/user/change-password', {
                    method: 'POST',
                    headers: postHeaders,
                    body: JSON.stringify({ currentPassword, newPassword, confirmNewPassword })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        passwordMessage.style.color = '#22c55e';
                        passwordForm.reset();
                    } else {
                        throw new Error(data.message);
                    }
                    passwordMessage.textContent = data.message;
                })
                .catch(error => {
                    passwordMessage.style.color = '#ef4444';
                    passwordMessage.textContent = error.message;
                })
                .finally(() => {
                    passwordSubmitBtn.disabled = false;
                    passwordSubmitBtn.textContent = 'Change Password';
                });
            });

            showPasswordBtn.addEventListener('click', () => {
                securitySection.classList.toggle('hidden');
                referralSection.classList.add('hidden');
            });

            showReferralBtn.addEventListener('click', () => {
                referralSection.classList.toggle('hidden');
                securitySection.classList.add('hidden');
            });

            logoutButton.addEventListener('click', () => {
                localStorage.removeItem('authToken');
                window.location.href = '/login.html';
            });

            window.addEventListener('resize', () => {
                winLossChart.resize();
            });
        });
    </script>
</body>
</html>
