<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trade - Trading App</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
    body { 
        font-family: 'Inter', sans-serif; 
        padding-bottom: 80px; 
        background-color: #0c1021; 
    }

    /* 5-ITEM Bottom Nav Style (Fixed) - MATCHED FROM DASHBOARD */
    .bottom-nav { 
        position: fixed; 
        bottom: 0; 
        left: 0; 
        width: 100%; 
        display: flex; 
        justify-content: space-around; 
        z-index: 1000; 
        background-color: #111827; 
        border-top: 1px solid #374151; 
        padding: 8px 0; 
    }
    .nav-link { 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        justify-content: center; 
        flex-grow: 1; 
        text-decoration: none; 
        color: #9ca3af; 
        font-weight: 500; 
        font-size: 0.75rem; /* 12px */
        transition: all 0.2s ease-in-out; 
        gap: 4px; 
        width: 20%; 
    }
    .nav-link svg { 
        width: 24px; 
        height: 24px; 
    }
    .nav-link.active { 
        color: #4ade80; 
        font-weight: 600; 
    }

    /* --- TAB PILL STYLING (MATCHES DASHBOARD) --- */
    .tab-link {
        padding: 0.5rem 1rem; /* 8px 16px */
        font-weight: 600;
        font-size: 0.875rem; /* 14px */
        color: #9ca3af; /* Default gray text */
        border-radius: 9999px; /* full pill */
        transition: all 0.2s;
        border: none;
        background-color: transparent;
    }
    .tab-link.active-pill {
        color: #111827; /* Dark text */
        background-color: #4ade80; /* Bright green pill */
    }
    /* --- End of Tab Styling --- */

    /* Original trade.html styles follow */
    .status-badge { padding: 4px 10px; border-radius: 9999px; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; line-height: 1; display: inline-block; }
    .status-win { background-color: rgba(34, 197, 94, 0.2); color: #22c55e; }
    .status-loss { background-color: rgba(239, 68, 68, 0.2); color: #ef4444; }
    .status-active { background-color: rgba(234, 179, 8, 0.2); color: #eab308; }
    .status-pending { background-color: rgba(59, 130, 246, 0.2); color: #3b82f6; }
    .status-default { background-color: rgba(107, 114, 128, 0.2); color: #9ca3af; }
    .cancel-btn { background-color: #f59e0b; color: white; border: none; padding: 2px 6px; font-size: 0.7rem; border-radius: 4px; cursor: pointer; margin-left: 8px; }
    input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type="number"] { -moz-appearance: textfield; }
    @keyframes price-flash-up { 0%,100% { background-color: transparent; } 50% { background-color: rgba(34,197,94,0.3); } }
    @keyframes price-flash-down { 0%,100% { background-color: transparent; } 50% { background-color: rgba(239,68,68,0.3); } }
    .price-up { animation: price-flash-up 0.5s ease-out; }
    .price-down { animation: price-flash-down 0.5s ease-out; }
    .time-scroller-container { overflow-x: auto; white-space: nowrap; padding-bottom: 10px; scrollbar-width: thin; scrollbar-color: #4b5563 #1f2937; }
    .time-scroller-container::-webkit-scrollbar { height: 6px; }
    .time-scroller-container::-webkit-scrollbar-track { background: #1f2937; }
    .time-scroller-container::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 3px; }
    .time-scroller { display: inline-flex; gap: 10px; }
    .time-option { padding: 8px 16px; background-color: #374151; color: #d1d5db; border: 1px solid transparent; border-radius: 9999px; cursor: pointer; font-weight: 500; transition: all 0.2s ease-in-out; }
    .time-option:hover { background-color: #4b5563; }
    .time-option.active { background-color: #3b82f6; color: white; font-weight: 700; box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); }
    .asset-dropdown { position: relative; display: inline-block; }
    .asset-dropdown-btn { background-color: #374151; color: white; padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; border: 1px solid #4b5563; }
    .asset-dropdown-content { display: none; position: absolute; background-color: #1f2937; min-width: 160px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.5); z-index: 1; border-radius: 8px; border: 1px solid #4b5563; margin-top: 4px; padding: 4px; }
    .asset-dropdown-content a { color: #d1d5db; padding: 10px 14px; text-decoration: none; display: block; border-radius: 6px; }
    .asset-dropdown-content a:hover { background-color: #4b5563; }
    .show { display: block; }

    /* Copy Trade Specific Styles */
    .copy-trade-card { 
        background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 100%); 
        border: 1px solid #4f46e5; 
        position: relative;
    }
    .copy-trade-card.expiring { 
        background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); 
        border-color: #ef4444; 
    }
    .copy-btn { 
        background: linear-gradient(135deg, #10b981 0%, #059669 100%); 
        transition: all 0.2s;
    }
    .copy-btn:hover { 
        background: linear-gradient(135deg, #059669 0%, #047857 100%); 
        transform: scale(1.02);
    }
    .copy-btn:disabled { 
        background: #6b7280; 
        cursor: not-allowed; 
    }

    @keyframes modal-in {
    from { opacity: 0; transform: scale(0.9); }
    to { opacity: 1; transform: scale(1); }
    }
    @keyframes modal-out {
    from { opacity: 1; transform: scale(1); }
    to { opacity: 0; transform: scale(0.9); }
    }
    @keyframes toast-in {
    from { opacity: 0; transform: translateY(-100%); }
    to { opacity: 1; transform: translateY(0); }
    }
    @keyframes toast-out {
    from { opacity: 1; transform: translateY(0); }
    to { opacity: 0; transform: translateY(-100%); }
    }
    @keyframes pulse-live {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
    }
    @keyframes confetti-fall {
    0% { transform: translateY(-100%) rotateZ(0deg); opacity: 1; }
    100% { transform: translateY(300px) rotateZ(360deg); opacity: 0; }
    }

    .modal, .modal-overlay { z-index: 9998; }
    .toast { z-index: 9999; }

    .modal.show, .modal-overlay.show {
    display: flex;
    animation: modal-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }
    .modal.hide, .modal-overlay.hide {
    animation: modal-out 0.2s ease-out forwards;
    }
    .toast.show {
    display: flex;
    animation: toast-in 0.4s ease-out forwards;
    }
    .toast.hide {
    animation: toast-out 0.3s ease-in forwards;
    }
    .live-dot {
    animation: pulse-live 1.5s infinite;
    }
    .confetti-particle {
    position: absolute;
    width: 8px;
    height: 16px;
    background-color: #f00;
    opacity: 0;
    animation: confetti-fall 2s ease-out forwards;
    }

    .header-container {
    background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
    border-radius: 12px;
    padding: 16px;
    border: 1px solid #374151;
    margin-bottom: 20px;
    }

    .asset-price-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    }

    .asset-info {
    display: flex;
    align-items: center;
    gap: 12px;
    }

    .price-info {
    text-align: right;
    }

    .current-price {
    font-size: 1.75rem;
    font-weight: 700;
    color: #4ade80; 
    font-family: 'Inter', monospace;
    }

    .timer-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(59, 130, 246, 0.1);
    padding: 12px 16px;
    border-radius: 8px;
    border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .timer-label {
    color: #93c5fd;
    font-weight: 600;
    font-size: 0.875rem;
    }

    .timer-value {
    font-size: 1.125rem;
    font-weight: 700;
    color: white;
    font-family: 'Inter', monospace;
    }

    .timer-value.warning {
    color: #fbbf24;
    animation: pulse 1s infinite;
    }

    .timer-value.critical {
    color: #ef4444;
    animation: pulse 0.5s infinite;
    }

    @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
    }

    .trade-details-modal {
    background: #1f2937;
    border-radius: 16px;
    padding: 0;
    max-width: 400px;
    width: 90%;
    border: 1px solid #374151;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
    }

    .trade-details-header {
    background: linear-gradient(135deg, #111827 0%, #1f2937 100%);
    padding: 20px 24px;
    border-bottom: 1px solid #374151;
    border-radius: 16px 16px 0 0;
    }

    .trade-details-title {
    font-size: 1.25rem;
    font-weight: 700;
    color: white;
    margin: 0;
    }

    .trade-details-body {
    padding: 24px;
    }

    .trade-detail-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #374151;
    }

    .trade-detail-row:last-child {
    border-bottom: none;
    }

    .trade-detail-label {
    color: #9ca3af;
    font-weight: 500;
    font-size: 0.875rem;
    }

    .trade-detail-value {
    color: white;
    font-weight: 600;
    font-size: 0.875rem;
    }

    .trade-detail-pnl {
    background: rgba(34, 197, 94, 0.1);
    padding: 16px;
    border-radius: 12px;
    margin-top: 16px;
    border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .trade-detail-pnl.loss {
    background: rgba(239, 68, 68, 0.1);
    border-color: rgba(239, 68, 68, 0.3);
    }

    .trade-detail-pnl .trade-detail-label {
    color: #d1d5db;
    font-size: 1rem;
    }

    .trade-detail-pnl .trade-detail-value {
    font-size: 1.25rem;
    }

    .trade-detail-pnl .trade-detail-value.positive {
    color: #10b981;
    }

    .trade-detail-pnl .trade-detail-value.negative {
    color: #ef4444;
    }

    .close-trade-details {
    background: #374151;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    width: 100%;
    margin-top: 16px;
    transition: background-color 0.2s;
    }

    .close-trade-details:hover {
    background: #4b5563;
    }

    #loadMoreTradesBtn {
    background-color: #374151;
    transition: background-color 0.2s ease-in-out;
    }
    #loadMoreTradesBtn:hover {
    background-color: #4b5563;
    }
    #loadMoreTradesBtn:disabled {
    background-color: #1f2937;
    color: #6b7280;
    cursor: not-allowed;
    }

    /* ⭐ FIX: Chart container styling */
    #candlestickContainer {
        background: #1f2937;
        border-radius: 0.5rem;
        border: 1px solid #374151;
    }

</style>
</head>

<body class="text-gray-100">
<script>
if (!localStorage.getItem('authToken')) window.location.href = '/login.html';
</script>

<div class="container mx-auto p-4 max-w-4xl">
    <header class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-bold text-white">Trading</h1>
            <p class="text-gray-400">Place your trades on the live market</p>
        </div>
        <div>
            <p class="text-lg">Balance: <span id="balance-display" class="font-bold text-green-400">$0.00</span></p>
            <!-- ⭐ FIX: Connection status indicator -->
            <div id="connection-status" class="text-xs mt-1">
                <span class="inline-block w-2 h-2 rounded-full bg-red-500 mr-1"></span>
                <span class="text-gray-400">Connecting...</span>
            </div>
        </div>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <div class="lg:col-span-2 space-y-4">

            <div>

                <div class="header-container !mb-4">
                    <div class="asset-price-section !mb-2">
                        <div class="asset-info">
                            <div class="asset-dropdown">
                                <button id="assetDropdownBtn" class="asset-dropdown-btn">
                                    <span id="selectedAssetSpan">Select Asset</span>
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                                <div id="assetDropdownContent" class="asset-dropdown-content"></div>
                            </div>
                        </div>
                        <div class="price-info">
                            <div class="current-price" id="currentPrice">-.--</div>
                        </div>
                    </div>

                    <div class="timer-section">
                        <div class="timer-label">NEXT CANDLE IN</div>
                        <div id="countdownSeconds" class="timer-value">--</div>
                    </div>
                </div>

                <div id="candlestickContainer" style="width: 100%; height: 400px;" class="bg-gray-900 rounded-lg"></div>
            </div>

            <div class="h-px bg-gray-700 mx-auto w-full max-w-lg lg:max-w-none"></div>

            <div class="bg-gray-800/50 p-1 rounded-full flex justify-between space-x-1" id="trade-tab-container">
                <button class="tab-link active-pill w-1/2" data-tab="trade">
                    <svg class="w-5 h-5 inline mr-1 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>
                    Live Trade
                </button>
                <button class="tab-link w-1/2" data-tab="copy-trade">
                    <svg class="w-5 h-5 inline mr-1 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h2a2 2 0 002-2v-4a2 2 0 00-2-2h-2m4 0l3-3m0 0l-3-3m0 3h-3m-6 0l-3 3m0 0l3 3"></path></svg>
                    Copy Trade
                </button>
            </div>

            <div id="trade-content" class="p-4 sm:p-6 space-y-6">

                <div class="flex justify-center gap-4 bg-gray-900/50 p-2 rounded-xl">
                    <button id="instantTradeBtn" class="flex-1 px-4 py-2 rounded-lg text-white font-semibold transition-all">Instant Trade</button>
                    <button id="scheduledTradeBtn" class="flex-1 px-4 py-2 rounded-lg text-white font-semibold transition-all">Scheduled Trade</button>
                </div>

                <div id="scheduledContainer" class="hidden">
                    <label class="text-sm text-gray-300 mb-2 block">Select Time</label>
                    <div id="time-scroller-container" class="time-scroller-container">
                        <div id="time-scroller" class="time-scroller"></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                    <div>
                        <label for="investmentAmount" class="text-sm font-medium text-gray-300">Amount ($)</label>
                        <input type="number" id="investmentAmount" min="0.5" step="0.01" class="w-full mt-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-green-400 focus:border-green-400" placeholder="e.g., 10.00">
                    </div>
                    <div class="md:col-span-2 grid grid-cols-2 gap-4 pt-5">
                        <button id="tradeUp" class="w-full py-3 font-bold text-white bg-green-600 hover:bg-green-700 rounded-lg transition-transform transform hover:scale-105 shadow-md shadow-green-900/50">UP</button>
                        <button id="tradeDown" class="w-full py-3 font-bold text-white bg-red-600 hover:bg-red-700 rounded-lg transition-transform transform hover:scale-105 shadow-md shadow-red-900/50">DOWN</button>
                    </div>
                </div>

                <div id="tradeStatus" class="text-center min-h-[24px] font-semibold"></div>
            </div>

            <div id="copy-trade-content" class="space-y-6 hidden p-4 sm:p-6">
                <section id="copyTradesSection" class="overflow-hidden">
                    <div class="bg-gradient-to-r from-blue-600 to-purple-700 p-4 rounded-xl">
                        <h2 class="text-xl font-bold text-white flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h2a2 2 0 002-2v-4a2 2 0 00-2-2h-2m4 0l3-3m0 0l-3-3m0 3h-3m-6 0l-3 3m0 0l3 3"></path>
                            </svg>
                            Available Copy Trades
                        </h2>
                        <p class="text-blue-100 text-sm">Follow expert traders automatically</p>
                    </div>

                    <div id="copyTradesContainer" class="p-4 space-y-4 max-h-[70vh] overflow-y-auto">
                        <div id="loadingPlaceholder" class="text-center py-8 text-blue-400 animate-pulse">
                            <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.836 0H20v-5m-1.418 5L12 15M4 12a8 8 0 0116 0z"></path>
                            </svg>
                            <p>Loading available copy trades...</p>
                        </div>
                        <div id="noCopyTrades" class="text-center py-8 text-gray-400 hidden">
                            <svg class="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            <p>No copy trades available right now.</p>
                            <p class="text-sm">Trades update every minute. Check back soon!</p>
                        </div>
                    </div>

                    <div id="copyTradeStatus" class="px-4 pb-4 text-center text-sm min-h-[20px] text-red-400"></div>
                </section>
            </div>


        </div>


        <div class="space-y-6 lg:col-span-1">
            <div class="p-4 space-y-4">
                <h2 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2">Trade History</h2>
                <div id="tradeHistoryContainer" class="overflow-y-auto h-96 pr-2 space-y-2">
                </div>
                <button id="loadMoreTradesBtn" class="w-full mt-4 py-2 px-4 font-semibold rounded-lg hidden bg-gray-700/50">
                    Load More
                </button>
            </div>
        </div>
    </main>
</div>

<!-- All modals included -->
<div id="modal-overlay" class="modal-overlay hidden fixed inset-0 bg-black/70 items-center justify-center"></div>
<div id="modal-pending" class="modal hidden fixed inset-0 items-center justify-center p-4">
    <div class="bg-gray-800 rounded-2xl shadow-2xl w-full max-w-sm border border-gray-700">
        <div class="p-8 text-center">
            <svg class="w-16 h-16 text-blue-500 mx-auto mb-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <h2 id="pending-title" class="text-3xl font-bold mb-2">Trade Scheduled</h2>
            <p class="text-gray-400 text-lg">
                Your <span id="pending-amount" class="font-bold text-white">$0.00</span> trade on
                <span id="pending-asset" class="font-bold text-white">ASSET</span>
                <span id="pending-time-container">
                    is set for <span id="pending-time" class="font-bold text-white">00:00:00</span>.
                </span>
            </p>
            <button class="btn-close mt-8 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-10 rounded-lg w-full transition-all">
                Got it
            </button>
        </div>
    </div>
</div>
<div id="toast-active" class="toast hidden fixed top-5 left-1/2 -translate-x-1/2">
    <div class="flex items-center bg-gray-700 text-white py-3 px-6 rounded-full shadow-2xl border border-gray-600">
        <span class="relative flex h-3 w-3 mr-3">
            <span class="live-dot absolute inline-flex h-full w-full rounded-full bg-yellow-400 opacity-75"></span>
            <span class="relative inline-flex rounded-full h-3 w-3 bg-yellow-500"></span>
        </span>
        <span class="font-semibold text-lg">Your trade is now ACTIVE!</span>
    </div>
</div>
<div id="modal-win" class="modal hidden fixed inset-0 items-center justify-center p-4">
    <div class="relative bg-gray-800 rounded-2xl shadow-2xl w-full max-w-sm border-2 border-green-500 overflow-hidden">
        <div id="confetti-container" class="absolute inset-0"></div>
        <div class="p-8 text-center relative z-10">
            <svg class="w-16 h-16 text-green-500 mx-auto mb-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M11 3a1 1 0 100 2h.586l-1.293 1.293a1 1 0 101.414 1.414L13 6.414V10a1 1 0 102 0V6.414l1.293 1.293a1 1 0 001.414-1.414L16.414 5H17a1 1 0 100-2h-6zM3.293 7.293a1 1 0 011.414 0L6 8.586V3a1 1 0 112 0v5.586l1.293-1.293a1 1 0 111.414 1.414L8.414 11H12a1 1 0 110 2H8.414l2.293 2.293a1 1 0 11-1.414 1.414L7 14.414V17a1 1 0 11-2 0v-2.586l-1.293 1.293a1 1 0 01-1.414-1.414L4.586 13H3a1 1 0 110-2h1.586l-1.293-1.293a1 1 0 010-1.414z"></path></svg>
            <h2 class="text-5xl font-extrabold text-green-400 mb-3">YOU WON!</h2>
            <p class="text-gray-300 text-xl mb-2">Trade Closed</p>
            <p id="win-amount" class="text-4xl font-bold text-white bg-green-500/20 py-2 px-4 rounded-lg inline-block">
                + $0.00
            </p>
            <button class="btn-close mt-8 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-10 rounded-lg w-full transition-all">
                Awesome!
            </button>
        </div>
    </div>
</div>
<div id="modal-loss" class="modal hidden fixed inset-0 items-center justify-center p-4">
    <div class="bg-gray-800 rounded-2xl shadow-2xl w-full max-w-sm border border-gray-700">
        <div class="p-8 text-center">
            <svg class="w-16 h-16 text-red-500 mx-auto mb-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2 2m2-2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <h2 class="text-3xl font-bold mb-2">Trade Closed</h2>
            <p class="text-gray-400 text-lg">
                Your <span id="loss-amount" class="font-bold text-white">$0.00</span> trade resulted in a loss. Better luck next time!
            </p>
            <button class="btn-close mt-8 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-10 rounded-lg w-full transition-all">
                Close
            </button>
        </div>
    </div>
</div>
<div id="modal-trade-details" class="modal hidden fixed inset-0 items-center justify-center p-4">
    <div class="trade-details-modal">
        <div class="trade-details-header">
            <h3 class="trade-details-title">Trade Details</h3>
        </div>
        <div class="trade-details-body">
            <div class="trade-detail-row">
                <span class="trade-detail-label">Asset</span>
                <span id="detail-asset" class="trade-detail-value">-</span>
            </div>
            <div class="trade-detail-row">
                <span class="trade-detail-label">Trade Time</span>
                <span id="detail-trade-time" class="trade-detail-value">-</span>
            </div>
            <div class="trade-detail-row">
                <span class="trade-detail-label">Opening Price</span>
                <span id="detail-opening-price" class="trade-detail-value">-</span>
            </div>
            <div class="trade-detail-row">
                <span class="trade-detail-label">Closing Price</span>
                <span id="detail-closing-price" class="trade-detail-value">-</span>
            </div>
            <div id="detail-pnl-container" class="trade-detail-pnl">
                <div class="trade-detail-row" style="border-bottom: none; padding: 0;">
                    <span class="trade-detail-label">Profit / Loss (P&L)</span>
                    <span id="detail-pnl" class="trade-detail-value positive">-</span>
                </div>
            </div>
            <button class="close-trade-details btn-close">Close</button>
        </div>
    </div>
</div>
<div id="modal-copy-success" class="modal hidden fixed inset-0 items-center justify-center p-4">
    <div class="bg-gray-800 rounded-2xl shadow-2xl w-full max-w-sm border border-gray-700">
        <div class="p-8 text-center">
            <svg class="w-16 h-16 text-green-500 mx-auto mb-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <h2 class="text-3xl font-bold mb-2">Trade Copied!</h2>
            <p class="text-gray-400 text-lg">
                You are now copying the trade for <span id="copy-success-asset" class="font-bold text-white">ASSET</span>.
                It will execute automatically.
            </p>
            <button class="btn-close mt-8 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-10 rounded-lg w-full transition-all">
                Great!
            </button>
        </div>
    </div>
</div>
<div id="toast-copy-executed" class="toast hidden fixed top-5 left-1/2 -translate-x-1/2">
    <div class="flex items-center bg-blue-600 text-white py-3 px-6 rounded-full shadow-2xl border border-blue-400">
        <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>
        <span id="copy-executed-text" class="font-semibold text-lg">Your copy trade has executed!</span>
    </div>
</div>

<nav class="bottom-nav">
    <a href="dashboard.html" class="nav-link" id="nav-dashboard">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
        <span>Home</span>
    </a>
    <a href="trade.html" class="nav-link active" id="nav-trade">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>
        <span>Trade</span>
    </a>
    <a href="deposit.html" class="nav-link" id="nav-deposit">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
        <span>Deposit</span>
    </a>
    <a href="withdraw.html" class="nav-link" id="nav-withdraw">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H4a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
        <span>Withdraw</span>
    </a>
    <a href="profile.html" class="nav-link" id="nav-profile">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
        <span>Profile</span>
    </a>
</nav>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Initial Nav Setup ---
    const currentPage = window.location.pathname.split('/').pop().replace('.html', '');
    document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
    document.getElementById(`nav-${currentPage}`).classList.add('active');

    const socket = io({ auth: { token: localStorage.getItem('authToken') } });

    // --- DOM Elements ---
    const balanceElem = document.getElementById('balance-display');
    const currentPriceElem = document.getElementById('currentPrice');
    const countdownSecondsElem = document.getElementById('countdownSeconds');
    const tradeHistoryContainer = document.getElementById('tradeHistoryContainer');
    const tradeUpBtn = document.getElementById('tradeUp');
    const tradeDownBtn = document.getElementById('tradeDown');
    const investmentInput = document.getElementById('investmentAmount');
    const tradeStatusElem = document.getElementById('tradeStatus');
    const instantBtn = document.getElementById("instantTradeBtn");
    const scheduledBtn = document.getElementById("scheduledTradeBtn");
    const scheduledContainer = document.getElementById("scheduledContainer");
    const timeScroller = document.getElementById("time-scroller");
    const assetDropdownBtn = document.getElementById('assetDropdownBtn');
    const selectedAssetSpan = document.getElementById('selectedAssetSpan');
    const assetDropdownContent = document.getElementById('assetDropdownContent');

    // Trade/Copy Trade Tab Elements
    const tradeTabContainer = document.getElementById('trade-tab-container');
    const tradeContent = document.getElementById('trade-content');
    const copyTradeContent = document.getElementById('copy-trade-content');

    // Copy Trade Elements
    const copyTradesContainer = document.getElementById('copyTradesContainer');
    const loadingPlaceholder = document.getElementById('loadingPlaceholder');
    const noCopyTrades = document.getElementById('noCopyTrades');
    const copyTradeStatus = document.getElementById('copyTradeStatus');

    // Charting
    const myChart = echarts.init(document.getElementById('candlestickContainer'), 'dark');

    // Popup Elements
    const overlay = document.getElementById('modal-overlay');
    const modalPending = document.getElementById('modal-pending');
    const toastActive = document.getElementById('toast-active');
    const modalWin = document.getElementById('modal-win');
    const modalLoss = document.getElementById('modal-loss');
    const modalTradeDetails = document.getElementById('modal-trade-details');
    const modalCopySuccess = document.getElementById('modal-copy-success'); 
    const toastCopyExecuted = document.getElementById('toast-copy-executed'); 

    const allModals = [modalPending, modalWin, modalLoss, modalTradeDetails, modalCopySuccess];

    // Trade History Pagination
    const loadMoreBtn = document.getElementById('loadMoreTradesBtn');
    let fullTradeHistory = [];
    let visibleHistoryCount = 0;
    const TRADES_PER_PAGE = 5;

    // State Variables
    let marketData = {}, currentAsset = '', lastPrice = 0, isScheduled = false;
    let availableCopyTrades = []; 
    let tradeHistoryData = {};
    let assetPrices = {};
    let activeTab = 'trade';

    // --- Charting Functions (FIXED) ---
    function initChart(candles) {
        if (!candles || candles.length === 0) { 
            myChart.clear(); 
            return; 
        }
        
        const chartData = candles.map(c => [c.open, c.close, c.low, c.high]);
        const chartDates = candles.map(c => new Date(c.timestamp).toLocaleTimeString([], { 
            hour: '2-digit', 
            minute: '2-digit'
        }));
        
        const options = {
            backgroundColor: 'transparent',
            tooltip: { 
                trigger: 'axis', 
                axisPointer: { type: 'cross' } 
            },
            xAxis: { 
                type: 'category', 
                data: chartDates, 
                axisLine: { lineStyle: { color: '#8392A5' } },
                axisLabel: {
                    rotate: 45,
                    color: '#9ca3af'
                }
            },
            yAxis: { 
                scale: true, 
                axisLine: { lineStyle: { color: '#8392A5' } }, 
                splitLine: { lineStyle: { color: '#2a2e39' } },
                axisLabel: {
                    color: '#9ca3af'
                }
            },
            grid: { left: '10%', right: '5%', bottom: '15%', top: '5%' },
            dataZoom: [{ 
                type: 'inside', 
                startValue: Math.max(0, chartDates.length - 50), 
                endValue: chartDates.length - 1,
                zoomOnMouseWheel: 'shift'
            }],
            series: [{ 
                type: 'candlestick', 
                data: chartData, 
                itemStyle: { 
                    color: '#22c55e', 
                    color0: '#ef4444', 
                    borderColor: '#22c55e', 
                    borderColor0: '#ef4444' 
                } 
            }]
        };
        
        myChart.setOption(options, true);
    }

    function updateChart(candles) {
        if (!candles || candles.length === 0) return;
        
        const chartData = candles.map(c => [c.open, c.close, c.low, c.high]);
        const chartDates = candles.map(c => new Date(c.timestamp).toLocaleTimeString([], { 
            hour: '2-digit', 
            minute: '2-digit'
        }));
        
        myChart.setOption({
            xAxis: { data: chartDates },
            series: [{ data: chartData }]
        });
    }

    // ⭐ FIX: Candle validation and normalization
    function normalizeCandle(candle, currentPrice) {
        if (!candle) {
            return {
                timestamp: Date.now(),
                open: currentPrice,
                high: currentPrice,
                low: currentPrice,
                close: currentPrice
            };
        }

        // Fix abnormal opening prices
        if (candle.open > currentPrice * 2 || candle.open < currentPrice / 2) {
            console.warn('Fixing abnormal candle opening:', {
                originalOpen: candle.open,
                currentPrice: currentPrice,
                fixedOpen: currentPrice
            });
            candle.open = currentPrice;
        }

        return {
            timestamp: candle.timestamp || Date.now(),
            open: candle.open,
            high: Math.max(candle.open, candle.high || candle.open, currentPrice),
            low: Math.min(candle.open, candle.low || candle.open, currentPrice),
            close: currentPrice
        };
    }

    // --- Connection Status Functions ---
    function updateConnectionStatus(status, message) {
        const statusElem = document.getElementById('connection-status');
        if (!statusElem) return;
        
        const dot = statusElem.querySelector('span:first-child');
        const text = statusElem.querySelector('span:last-child');
        
        dot.className = `inline-block w-2 h-2 rounded-full mr-1 ${
            status === 'connected' ? 'bg-green-500' : 
            status === 'disconnected' ? 'bg-red-500' : 'bg-yellow-500'
        }`;
        text.textContent = message;
        text.className = `text-xs ${status === 'connected' ? 'text-green-400' : 
                         status === 'disconnected' ? 'text-red-400' : 'text-yellow-400'}`;
    }

    // --- Socket.IO Event Handlers ---
    socket.on('connect', () => {
        console.log('Connected to server');
        updateConnectionStatus('connected', 'Connected');
        showStatus('Connected to server', 'green');
    });

    socket.on('disconnect', (reason) => {
        console.log('Disconnected:', reason);
        updateConnectionStatus('disconnected', 'Disconnected');
        showStatus('Disconnected from server', 'red');
    });

    socket.on('connect_error', (error) => {
        console.log('Connection error:', error.message);
        updateConnectionStatus('disconnected', 'Connection failed');
    });

    // ⭐ FIX: Proper market_data handler with candle normalization
    socket.on('market_data', (data) => { 
        if (data.asset === currentAsset) {
            console.log('Market Data Received for:', data.asset);
            
            if (!marketData[data.asset]) {
                marketData[data.asset] = {};
            }
            
            const currentPrice = data.currentPrice || lastPrice;
            
            marketData[data.asset].candles = data.candles || [];
            marketData[data.asset].currentPrice = currentPrice;
            
            // ⭐ FIX: Normalize current forming candle
            marketData[data.asset].currentCandle = normalizeCandle(data.currentCandle, currentPrice);
            
            const completeCandles = [
                ...(marketData[data.asset].candles || []),
                marketData[data.asset].currentCandle
            ].filter(candle => candle && typeof candle.open === 'number');
            
            console.log('Complete candles:', completeCandles.length);
            
            if (completeCandles.length > 0) {
                updateChart(completeCandles);
            }
            
            if (data.currentPrice && data.currentPrice !== lastPrice) {
                currentPriceElem.classList.remove('price-up', 'price-down');
                currentPriceElem.classList.add(data.currentPrice > lastPrice ? 'price-up' : 'price-down');
                currentPriceElem.textContent = formatPrice(data.currentPrice, currentAsset);
                lastPrice = data.currentPrice;
            }
        }
    });

    socket.on('init', (data) => {
        console.log('Received init data');
        
        marketData = {};
        
        const assets = Object.keys(data.marketData || ['BTCUSDT', 'ETHUSDT', 'BNBUSDT', 'SOLUSDT']);
        populateAssetSelector(assets);

        const lastAsset = localStorage.getItem('lastSelectedAsset');
        currentAsset = (lastAsset && assets.includes(lastAsset)) ? lastAsset : assets[0];
        setActiveAsset(currentAsset);

        updateBalance(data.balance);

        tradeHistoryContainer.innerHTML = '';
        fullTradeHistory = data.tradeHistory || [];
        visibleHistoryCount = 0;
        loadMoreTrades();

        initChart([]);
    });

    socket.on('copy_trades_available', (data) => {
        if (activeTab === 'copy-trade') {
            availableCopyTrades = data.copyTrades || [];
            renderCopyTrades();
        }
    });

    socket.on('copy_trade_success', (data) => {
        showCopySuccessPopup(data.asset || 'that trade'); 
        socket.emit('request_copy_trades'); 

        const allCopyBtns = document.querySelectorAll('.copy-btn');
        allCopyBtns.forEach(btn => {
            btn.disabled = false;
            if(btn.textContent === 'Copying...') btn.textContent = 'Copy Trade';
        });
    });

    socket.on('copy_trade_executed', (data) => {
        showCopyExecutedToast(data.trade);
        updateBalance(data.balance);
        addTradeToHistory(data.trade);
    });

    socket.on('price_update', (data) => {
        Object.entries(data).forEach(([asset, assetData]) => {
            assetPrices[asset] = assetData.price;
            if (marketData[asset]) {
                marketData[asset].currentPrice = assetData.price;
            }
        });

        if (data[currentAsset]) {
            const newPrice = data[currentAsset].price;
            const countdown = data[currentAsset].countdown;

            currentPriceElem.classList.remove('price-up', 'price-down');
            if (lastPrice !== 0 && newPrice !== lastPrice) {
                currentPriceElem.classList.add(newPrice > lastPrice ? 'price-up' : 'price-down');
            }

            currentPriceElem.textContent = formatPrice(newPrice, currentAsset);

            countdownSecondsElem.textContent = `${countdown}s`;
            countdownSecondsElem.classList.remove('warning', 'critical');
            if (countdown <= 10) {
                countdownSecondsElem.classList.add('critical');
            } else if (countdown <= 30) {
                countdownSecondsElem.classList.add('warning');
            }

            lastPrice = newPrice;
        }
    });

    socket.on('trade_pending', (data) => { 
        updateBalance(data.balance); 
        addTradeToHistory(data.trade);
        showPendingPopup(data.trade);
    });

    socket.on('trade_scheduled', (data) => { 
        updateBalance(data.balance); 
        addTradeToHistory(data.trade);
        showScheduledPopup(data.trade);
    });

    socket.on('trade_active', (data) => {
        tradeHistoryData[data.trade._id] = data.trade;
        const tradeRow = document.getElementById(`trade-${data.trade._id}`);
        if (!tradeRow) {
            addTradeToHistory(data.trade);
        } else {
            updateTradeStatus(data.trade._id, 'Active');
        }
        showToast(toastActive);
    });

    socket.on('trade_result', (data) => {
        updateBalance(data.balance);
        tradeHistoryData[data.trade._id] = data.trade;
        const tradeRow = document.getElementById(`trade-${data.trade._id}`);
        if (!tradeRow) {
            addTradeToHistory(data.trade);
        } else {
            updateTradeStatus(data.trade._id, data.trade.status, data.trade.result);
        }
        setTradeButtonsDisabled(false);

        if (data.trade.result === 'WIN') {
            showWinPopup(data.trade);
        } else if (data.trade.result === 'LOSS') {
            showLossPopup(data.trade);
        }
    });

    socket.on('trade_cancelled', (data) => { 
        updateBalance(data.balance); 
        delete tradeHistoryData[data.tradeId];
        const row = document.getElementById(`trade-${data.tradeId}`); 
        if (row) row.remove(); 
        showStatus('Trade cancelled.', 'gray'); 
        setTradeButtonsDisabled(false); 
    });

    socket.on('error', (data) => { 
        showStatus(`Error: ${data.message}`, 'red'); 
        setTradeButtonsDisabled(false); 

        const allCopyBtns = document.querySelectorAll('.copy-btn');
        allCopyBtns.forEach(btn => {
            btn.disabled = false;
            if(btn.textContent === 'Copying...') btn.textContent = 'Copy Trade';
        });
    });

    // --- Tab Switching Logic ---
    tradeTabContainer.addEventListener('click', (e) => {
        if (e.target.tagName !== 'BUTTON') return;

        tradeTabContainer.querySelectorAll('.tab-link').forEach(btn => btn.classList.remove('active-pill'));
        e.target.classList.add('active-pill');

        activeTab = e.target.getAttribute('data-tab');

        if (activeTab === 'trade') {
            copyTradeContent.classList.add('hidden');
            tradeContent.classList.remove('hidden');
        } else if (activeTab === 'copy-trade') {
            tradeContent.classList.add('hidden');
            copyTradeContent.classList.remove('hidden');
            fetchCopyTrades();
        }
    });

    // --- Helper Functions ---
    function formatPrice(price, asset) {
        const decimalMap = {
            'BTCUSDT': 2, 'ETHUSDT': 2, 'BNBUSDT': 2, 'LTCUSDT': 2, 'SOLUSDT': 2, 'AVAXUSDT': 2,
            'ADAUSDT': 4, 'MATICUSDT': 4, 'XRPUSDT': 4, 'DOTUSDT': 3, 'DOGEUSDT': 5
        };
        const decimals = decimalMap[asset] || 2;
        return price.toFixed(decimals);
    }

    // --- Copy Trading Functions ---
    async function fetchCopyTrades() {
        if (activeTab !== 'copy-trade') return;

        loadingPlaceholder.classList.remove('hidden');
        noCopyTrades.classList.add('hidden');
        copyTradesContainer.innerHTML = ''; 

        try {
            const response = await fetch('/api/user/copy-trades/available', {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                    'Content-Type': 'application/json'
                }
            });
            if (!response.ok) throw new Error('Failed to fetch copy trades');

            const data = await response.json();
            if (data.success) {
                availableCopyTrades = data.copyTrades || [];
                renderCopyTrades();
            }
        } catch (error) {
            console.error('Error fetching copy trades:', error);
            copyTradeStatus.textContent = 'Error loading copy trades';
        } finally {
            loadingPlaceholder.classList.add('hidden');
        }
    }

    function renderCopyTrades() {
        if (availableCopyTrades.length === 0) {
            noCopyTrades.classList.remove('hidden');
            copyTradesContainer.innerHTML = '';
            copyTradesContainer.appendChild(noCopyTrades);
            return;
        }

        noCopyTrades.classList.add('hidden');
        copyTradesContainer.innerHTML = '';

        availableCopyTrades.forEach(trade => {
            const now = new Date();
            const executionTime = new Date(trade.executionTime);
            const timeLeft = executionTime - now;
            const minutesLeft = Math.max(0, Math.floor(timeLeft / (1000 * 60)));
            const isExpiringSoon = minutesLeft < 5;

            const tradeCard = document.createElement('div');
            tradeCard.className = `copy-trade-card p-4 rounded-lg shadow-lg ${isExpiringSoon ? 'expiring' : ''}`;

            const directionIcon = trade.direction === 'CALL' 
                ? `<svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>`
                : `<svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>`;

            tradeCard.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div class="flex items-center gap-2">
                        ${directionIcon}
                        <span class="font-bold text-white text-lg">${trade.tradingPair}</span>
                    </div>
                    <span class="text-sm px-2 py-1 rounded-full ${trade.direction === 'CALL' ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}">
                        ${trade.direction}
                    </span>
                </div>
                <div class="grid grid-cols-2 gap-2 text-sm mb-3">
                    <div>
                        <span class="text-gray-300">Percentage:</span>
                        <span class="text-yellow-400 font-semibold ml-1">${trade.percentage}%</span>
                    </div>
                    <div>
                        <span class="text-gray-300">Your Investment:</span>
                        <span class="text-green-400 font-semibold ml-1">${trade.percentage.toFixed(2)}% of balance</span>
                    </div>
                    <div class="col-span-2">
                        <span class="text-gray-300">Executes in:</span>
                        <span class="text-blue-400 font-semibold ml-1 ${isExpiringSoon ? 'text-orange-400' : ''}">
                            ${minutesLeft} minutes
                        </span>
                    </div>
                </div>
                <button data-id="${trade._id}" data-asset="${trade.tradingPair}"
                    class="copy-btn w-full py-2 text-white font-semibold rounded-lg transition-all hover:scale-105 active:scale-95">
                    Copy Trade
                </button>
            `;
            copyTradesContainer.appendChild(tradeCard);
        });

        document.querySelectorAll('.copy-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const copyTradeId = btn.getAttribute('data-id');
                const asset = btn.getAttribute('data-asset');

                btn.textContent = 'Copying...';
                btn.disabled = true;

                socket.emit('copy_trade', { copyTradeId, asset }); 
            });
        });
    }

    // --- Asset Dropdown Logic ---
    assetDropdownBtn.addEventListener('click', () => assetDropdownContent.classList.toggle('show'));

    window.onclick = (event) => {
        if (!event.target.matches('.asset-dropdown-btn, .asset-dropdown-btn *') && assetDropdownContent.classList.contains('show')) {
            assetDropdownContent.classList.remove('show');
        }
    }

    function populateAssetSelector(assets) {
        assetDropdownContent.innerHTML = '';
        assets.forEach(asset => {
            const link = document.createElement('a');
            link.href = "#"; link.textContent = asset; link.dataset.asset = asset;
            link.addEventListener('click', (e) => {
                e.preventDefault();
                currentAsset = asset;
                localStorage.setItem('lastSelectedAsset', currentAsset);
                selectedAssetSpan.textContent = currentAsset;
                assetDropdownContent.classList.remove('show');
                updateUIForCurrentAsset();
            });
            assetDropdownContent.appendChild(link);
        });
    }

    function setActiveAsset(asset) { 
        selectedAssetSpan.textContent = asset;
    }

    // --- Time Scroller & Trade Mode ---
    function populateTimeSelector() {
        const now = new Date();
        timeScroller.innerHTML = '';
        for (let i = 1; i <= 10; i++) {
            const futureTime = new Date(now.getTime() + i * 60 * 1000);
            const timeString = `${futureTime.getHours().toString().padStart(2, '0')}:${futureTime.getMinutes().toString().padStart(2, '0')}`;
            const button = document.createElement('button');
            button.className = 'time-option'; button.textContent = timeString; button.dataset.time = timeString;
            if (i === 1) button.classList.add('active');

            button.addEventListener('click', () => {
                timeScroller.querySelectorAll('.time-option').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
            });
            timeScroller.appendChild(button);
        }
    }

    function setTradeMode(scheduled) {
        isScheduled = scheduled;
        if (isScheduled) {
            scheduledBtn.classList.add('bg-yellow-600'); scheduledBtn.classList.remove('opacity-60');
            instantBtn.classList.remove('bg-blue-600'); instantBtn.classList.add('opacity-60');
            populateTimeSelector();
            scheduledContainer.classList.remove("hidden");
        } else {
            instantBtn.classList.add('bg-blue-600'); instantBtn.classList.remove('opacity-60');
            scheduledBtn.classList.remove('bg-yellow-600'); scheduledBtn.classList.add('opacity-60');
            scheduledContainer.classList.add("hidden");
        }
    }
    instantBtn.addEventListener("click", () => setTradeMode(false));
    scheduledBtn.addEventListener("click", () => setTradeMode(true));

    // --- Core Trade & UI Functions ---
    const requestTrade = (direction) => {
        setTradeButtonsDisabled(true);
        const amount = parseFloat(investmentInput.value);
        if (isNaN(amount) || amount < 0.5) {
            showStatus('Invalid amount. Minimum is $0.50.', 'red');
            setTradeButtonsDisabled(false);
            return;
        }

        const currentPrice = assetPrices[currentAsset] || lastPrice;
        if (currentPrice === 0) {
            showStatus('Waiting for price data...', 'red');
            setTradeButtonsDisabled(false);
            return;
        }

        const tradeData = { 
            direction, 
            asset: currentAsset, 
            amount,
            openingPrice: currentPrice
        };

        if (isScheduled) {
            const activeTimeButton = timeScroller.querySelector('.time-option.active');
            if (!activeTimeButton) { 
                showStatus('Please select a time.', 'red'); 
                setTradeButtonsDisabled(false); 
                return; 
            }
            tradeData.scheduledTime = activeTimeButton.dataset.time;
            socket.emit("schedule_trade", tradeData);
        } else {
            socket.emit("trade", tradeData);
        }
    };
    tradeUpBtn.addEventListener("click", () => requestTrade("UP"));
    tradeDownBtn.addEventListener("click", () => requestTrade("DOWN"));

    function updateBalance(newBalance) {
        balanceElem.textContent = `$${newBalance.toFixed(2)}`;
        socket.emit('request_copy_trades'); 
    }

    // --- Trade History Functions ---
    function createTradeHistoryRow(trade) {
        tradeHistoryData[trade._id] = trade;
        const tradeElement = document.createElement('div');
        tradeElement.id = `trade-${trade._id}`;
        tradeElement.className = 'flex justify-between items-center bg-gray-700/50 p-3 rounded-lg transition-all hover:bg-gray-700 cursor-pointer';

        tradeElement.addEventListener('click', () => showTradeDetails(trade._id));

        const directionIcon = (trade.direction === 'UP' || trade.direction === 'CALL')
            ? `<svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>`
            : `<svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>`;

        tradeElement.innerHTML = `
            <div class="flex items-center gap-3">
                ${directionIcon}
                <div>
                    <p class="font-bold text-white">${trade.asset || trade.tradingPair}</p>
                    <p class="text-xs text-gray-400">Amount: $${trade.amount.toFixed(2)}</p>
                </div>
            </div>
            <div id="status-${trade._id}" class="text-right"></div>
        `;
        return tradeElement;
    }

    function loadMoreTrades() {
        const startIndex = visibleHistoryCount;
        const endIndex = startIndex + TRADES_PER_PAGE;
        const tradesToLoad = fullTradeHistory.slice(startIndex, endIndex);

        if (tradesToLoad.length === 0 && startIndex === 0) {
            loadMoreBtn.classList.add('hidden');
            return;
        }

        tradesToLoad.forEach(trade => {
            const tradeElement = createTradeHistoryRow(trade);
            tradeHistoryContainer.append(tradeElement); 
            updateTradeStatus(trade._id, trade.status, trade.result);
        });

        visibleHistoryCount = endIndex;

        if (visibleHistoryCount >= fullTradeHistory.length) {
            loadMoreBtn.textContent = 'No More Trades';
            loadMoreBtn.disabled = true;
        } else {
            loadMoreBtn.textContent = 'Load More';
            loadMoreBtn.disabled = false;
        }
        loadMoreBtn.classList.remove('hidden');
    }
    loadMoreBtn.addEventListener('click', loadMoreTrades);

    function addTradeToHistory(trade) {
        const tradeElement = createTradeHistoryRow(trade);
        tradeHistoryContainer.prepend(tradeElement); 
        updateTradeStatus(trade._id, trade.status, trade.result);
    }

    function updateTradeStatus(tradeId, status, result = null) {
        const statusContainer = document.getElementById(`status-${tradeId}`);
        if (!statusContainer) return;

        let statusText = (result || status).toUpperCase();
        let statusClass = 'status-default';

        if (result === 'WIN') statusClass = 'status-win';
        else if (result === 'LOSS') statusClass = 'status-loss';
        else if (status.toLowerCase() === 'active') statusClass = 'status-active';
        else if (status.toLowerCase() === 'pending' || status.toLowerCase() === 'scheduled') statusClass = 'status-pending';

        let statusContent = `<span class="status-badge ${statusClass}">${statusText}</span>`;
        if (status.toLowerCase() === 'pending' || status.toLowerCase() === 'scheduled') {
            statusContent += ` <button onclick="event.stopPropagation(); cancelTrade('${tradeId}')" class="cancel-btn">Cancel</button>`;
        }
        statusContainer.innerHTML = statusContent;
    }

    window.cancelTrade = (tradeId) => {
        socket.emit('cancel_trade', { tradeId });
    };

    // --- UI Helper Functions ---
    function showStatus(message, color) { 
        const colorMap = { red: 'text-red-400', green: 'text-green-500', blue: 'text-blue-400', yellow: 'text-yellow-500', gray: 'text-gray-400' }; 
        tradeStatusElem.textContent = message; 
        tradeStatusElem.className = `text-center mt-4 min-h-[24px] font-semibold ${colorMap[color] || 'text-gray-400'}`; 
    }

    function setTradeButtonsDisabled(disabled) { 
        [tradeUpBtn, tradeDownBtn].forEach(btn => { 
            btn.disabled = disabled; 
            btn.classList.toggle('opacity-50', disabled); 
            btn.classList.toggle('cursor-not-allowed', disabled); 
        }); 
    }

    function updateUIForCurrentAsset() {
        if (marketData[currentAsset] && marketData[currentAsset].candles) {
            const completeCandles = [
                ...(marketData[currentAsset].candles || []),
                ...(marketData[currentAsset].currentCandle ? [marketData[currentAsset].currentCandle] : [])
            ];
            initChart(completeCandles);
            const price = marketData[currentAsset].currentPrice || 0;
            currentPriceElem.textContent = formatPrice(price, currentAsset);
            lastPrice = price;
        } else {
            initChart([]);
            currentPriceElem.textContent = '-.--';
            lastPrice = 0;
        }
    }

    window.addEventListener('resize', () => {
        if (myChart) myChart.resize();
    });

    // --- Popup & Modal Functions ---
    function showModal(modal) {
        hideAllModals(); 
        overlay.classList.remove('hide');
        overlay.classList.add('show');
        modal.classList.remove('hide');
        modal.classList.add('show');

        if (modal === modalWin) {
            triggerConfetti();
        }
    }

    function hideModal(modal) {
        overlay.classList.remove('show');
        overlay.classList.add('hide');
        modal.classList.remove('show');
        modal.classList.add('hide');

        setTimeout(() => {
            overlay.classList.remove('show', 'hide');
            modal.classList.remove('show', 'hide');
        }, 300);
    }

    function hideAllModals() {
        allModals.forEach(m => {
            m.classList.remove('show', 'hide');
        });
        overlay.classList.remove('show', 'hide');
    }

    function showToast(toast) {
        toast.classList.remove('hide');
        toast.classList.add('show');
        setTimeout(() => {
            toast.classList.remove('show');
            toast.classList.add('hide');
            setTimeout(() => toast.classList.remove('hide'), 300);
        }, 3000);
    }

    // --- Popup Content Setters ---
    function showPendingPopup(trade) {
        document.getElementById('pending-title').textContent = 'Trade Pending';
        document.getElementById('pending-amount').textContent = `$${trade.amount.toFixed(2)}`;
        document.getElementById('pending-asset').textContent = trade.asset;
        document.getElementById('pending-time-container').style.display = 'none';
        showModal(modalPending);
    }

    function showScheduledPopup(trade) {
        document.getElementById('pending-title').textContent = 'Trade Scheduled';
        document.getElementById('pending-amount').textContent = `$${trade.amount.toFixed(2)}`;
        document.getElementById('pending-asset').textContent = trade.asset;
        document.getElementById('pending-time').textContent = new Date(trade.scheduledTime).toLocaleTimeString();
        document.getElementById('pending-time-container').style.display = 'inline';
        showModal(modalPending);
    }

    function showWinPopup(trade) {
        document.getElementById('win-amount').textContent = `+ $${trade.pnl.toFixed(2)}`;
        showModal(modalWin);
    }

    function showLossPopup(trade) {
        document.getElementById('loss-amount').textContent = `$${Math.abs(trade.pnl).toFixed(2)}`;
        showModal(modalLoss);
    }

    function showCopySuccessPopup(asset) { 
        document.getElementById('copy-success-asset').textContent = asset;
        showModal(modalCopySuccess);
    }

    function showCopyExecutedToast(trade) { 
        document.getElementById('copy-executed-text').textContent = `Copy trade for ${trade.asset || trade.tradingPair} is now active!`;
        showToast(toastCopyExecuted);
    }

    function showTradeDetails(tradeId) {
        const trade = tradeHistoryData[tradeId];
        if (!trade) return;

        const asset = trade.asset || trade.tradingPair;
        const pnl = trade.pnl;
        const openingPrice = trade.openingPrice || trade.entryPrice;
        const closingPrice = trade.closingPrice || trade.exitPrice;

        document.getElementById('detail-asset').textContent = asset;
        document.getElementById('detail-trade-time').textContent = new Date(trade.timestamp || trade.createdAt).toLocaleString();
        document.getElementById('detail-opening-price').textContent = openingPrice ? `$${formatPrice(openingPrice, asset)}` : 'N/A';
        document.getElementById('detail-closing-price').textContent = closingPrice ? `$${formatPrice(closingPrice, asset)}` : 'N/A';

        const pnlElement = document.getElementById('detail-pnl');
        const pnlContainer = document.getElementById('detail-pnl-container');

        if (pnl !== undefined) {
            const isPositive = pnl >= 0;
            pnlElement.textContent = `${isPositive ? '+' : ''}$${pnl.toFixed(2)}`;
            pnlElement.className = `trade-detail-value ${isPositive ? 'positive' : 'negative'}`;
            pnlContainer.className = `trade-detail-pnl ${isPositive ? '' : 'loss'}`;
            pnlContainer.style.display = 'block';
        } else {
            pnlContainer.style.display = 'none';
        }

        showModal(modalTradeDetails);
    }

    // --- Event Listeners for Close Buttons ---
    const closeButtons = document.querySelectorAll('.btn-close, .close-trade-details');
    closeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const modal = btn.closest('.modal');
            if(modal) hideModal(modal);
        });
    });

    overlay.addEventListener('click', () => {
        allModals.forEach(modal => {
            if (modal.classList.contains('show')) {
                hideModal(modal);
            }
        });
    });

    // --- Confetti Logic ---
    function triggerConfetti() {
        const container = document.getElementById('confetti-container');
        container.innerHTML = '';
        const colors = ['#059669', '#10b981', '#34d399', '#fde047', '#facc15'];

        for (let i = 0; i < 30; i++) {
            const particle = document.createElement('div');
            particle.classList.add('confetti-particle');
            const x = Math.random() * 100 + '%';
            const delay = Math.random() * 0.5 + 's';
            const color = colors[Math.floor(Math.random() * colors.length)];
            const rotation = Math.random() * 360 + 'deg';

            particle.style.left = x;
            particle.style.animationDelay = delay;
            particle.style.backgroundColor = color;
            particle.style.transform = `rotateZ(${rotation})`;

            container.appendChild(particle);
        }
        setTimeout(() => { container.innerHTML = ''; }, 2500);
    }

    // --- Initializations ---
    setTradeMode(false);
    populateTimeSelector();
    setInterval(populateTimeSelector, 60000);
    setInterval(() => socket.emit('request_copy_trades'), 30000); 
});
</script>
</body>
</html>
